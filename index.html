<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工報支自動核對與追蹤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: #f8fafc; }

        /* 自訂圓角 */
        .r-32 { border-radius: 32px; }
        .r-40 { border-radius: 40px; }
        .r-48 { border-radius: 48px; }
        .r-24 { border-radius: 24px; }

        /* 輸入框 */
        .field-input {
            width: 100%;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
            font-weight: 800;
            outline: none;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .field-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        .field-input.field-warning {
            border-color: #fbbf24;
            color: #d97706;
        }
        .field-input.field-error {
            border-color: #ef4444;
            color: #dc2626;
        }

        /* 大金額輸入 */
        .amount-input {
            width: 100%;
            background: transparent;
            font-size: 2.25rem;
            font-weight: 900;
            outline: none;
            border: none;
        }

        /* 切換按鈕 */
        .toggle-btn {
            padding: 12px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }
        .toggle-btn.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
            transform: scale(1.05);
        }
        .toggle-btn.inactive {
            background: #f1f5f9;
            color: #cbd5e1;
        }

        /* 狀態指示燈 */
        .status-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .status-dot.on {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }
        .status-dot.off {
            background: #1e293b;
            color: #475569;
        }

        /* Toast 動畫 */
        @keyframes slideIn {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-anim { animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Modal 縮放動畫 */
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* 自訂滾動條 */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 2px; }

        /* 拖放區 highlight */
        .drop-zone {
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            border-color: #3b82f6 !important;
            background: rgba(59, 130, 246, 0.05) !important;
            transform: scale(1.01);
        }

        /* 手機橫向滾動統計列 */
        .stats-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 4px;
        }
        .stats-scroll::-webkit-scrollbar { display: none; }
        .stats-scroll > div {
            scroll-snap-align: start;
            flex-shrink: 0;
        }
        @media (min-width: 768px) {
            .stats-scroll { display: grid; grid-template-columns: repeat(4, 1fr); overflow: visible; }
            .stats-scroll > div { flex-shrink: unset; }
        }

        /* Compliance Check 項目進場動畫 */
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .check-item {
            animation: fadeSlideUp 0.3s ease both;
        }

        /* 修復建議提示 */
        .fix-hint {
            margin-top: 4px;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: flex-start;
            gap: 6px;
            line-height: 1.4;
        }
        .fix-hint.warn { background: rgba(245, 158, 11, 0.1); color: #d97706; }
        .fix-hint.err  { background: rgba(239, 68, 68, 0.08); color: #dc2626; }
        .fix-hint.ok   { background: rgba(34, 197, 94, 0.08); color: #16a34a; }

        /* 發票拖放小區 */
        .invoice-drop {
            border: 2px dashed #e2e8f0;
            border-radius: 16px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .invoice-drop:hover, .invoice-drop.drag-over {
            border-color: #818cf8;
            background: rgba(129, 140, 248, 0.04);
        }
        .invoice-drop.has-file {
            border-color: #22c55e;
            border-style: solid;
            background: rgba(34, 197, 94, 0.04);
        }
    </style>
</head>
<body class="min-h-screen p-4 lg:p-8 text-slate-900">

    <!-- Toast 容器 -->
    <div id="toastContainer" class="fixed top-6 right-6 z-50 flex flex-col gap-3"></div>

    <!-- ===== 頂部導航 ===== -->
    <header class="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row justify-between items-center gap-6 bg-white p-6 r-32 shadow-sm border border-slate-200">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-600 r-24 flex items-center justify-center text-white shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-black text-slate-800 tracking-tight">員工報支自動核對與追蹤</h1>
                <div class="flex items-center gap-2 text-slate-400 text-[10px] font-bold uppercase tracking-widest mt-1">
                    <svg class="w-3 h-3 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                    </svg>
                    Local Storage Active
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4 flex-1 max-w-xl">
            <div class="relative flex-1 group">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
                <input type="text" id="employeeName" placeholder="輸入姓名/編號..."
                    class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-100 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all shadow-inner" />
                <div id="identityBadge" class="absolute right-3 top-1/2 -translate-y-1/2 bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] font-black uppercase hidden">
                    已識別身分
                </div>
            </div>
            <div class="bg-slate-50 p-1 rounded-2xl border border-slate-100 flex items-center shadow-inner">
                <select id="userRole" class="bg-transparent px-4 py-2 font-black text-xs text-blue-600 outline-none cursor-pointer">
                    <option value="manager">主管 (1399)</option>
                    <option value="staff" selected>一般員工 (800)</option>
                    <option value="special">特定專案 (500)</option>
                </select>
            </div>
        </div>
    </header>

    <!-- ===== 統計卡片 (手機橫向滾動 / 桌機 4 格) ===== -->
    <div class="max-w-7xl mx-auto mb-6">
        <div class="stats-scroll">
            <div class="bg-white r-24 p-5 shadow-sm border border-slate-200 min-w-[160px]">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">本月申報</span>
                    <div class="w-8 h-8 bg-blue-50 rounded-xl flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                    </div>
                </div>
                <div class="text-2xl font-black text-slate-800" id="statThisMonth">0</div>
                <div class="text-[9px] font-bold text-slate-300 uppercase mt-1">Records This Month</div>
            </div>
            <div class="bg-white r-24 p-5 shadow-sm border border-slate-200 min-w-[160px]">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">通過率</span>
                    <div class="w-8 h-8 bg-green-50 rounded-xl flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    </div>
                </div>
                <div class="text-2xl font-black text-slate-800" id="statPassRate">--</div>
                <div class="text-[9px] font-bold text-slate-300 uppercase mt-1">Compliance Rate</div>
            </div>
            <div class="bg-white r-24 p-5 shadow-sm border border-slate-200 min-w-[160px]">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">累計金額</span>
                    <div class="w-8 h-8 bg-amber-50 rounded-xl flex items-center justify-center">
                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                </div>
                <div class="text-2xl font-black text-slate-800" id="statTotalAmt">$0</div>
                <div class="text-[9px] font-bold text-slate-300 uppercase mt-1">Total Claimed</div>
            </div>
            <div class="bg-white r-24 p-5 shadow-sm border border-slate-200 min-w-[160px]">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">總紀錄</span>
                    <div class="w-8 h-8 bg-indigo-50 rounded-xl flex items-center justify-center">
                        <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                    </div>
                </div>
                <div class="text-2xl font-black text-slate-800" id="statTotalCount">0</div>
                <div class="text-[9px] font-bold text-slate-300 uppercase mt-1">All Records</div>
            </div>
        </div>
    </div>

    <!-- ===== 主內容 ===== -->
    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- ====== 左側 (8 cols) ====== -->
        <div class="lg:col-span-8 space-y-6">

            <!-- 影像辨識區 -->
            <section id="mainDropZone" class="bg-white r-40 p-8 shadow-sm border border-slate-200 drop-zone">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-black flex items-center gap-2 text-slate-700 italic">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>
                        </svg>
                        影像自動辨識與提取
                    </h2>
                    <div class="flex items-center gap-2 text-[10px] font-black text-slate-300 uppercase tracking-widest">
                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                        OCR Auto-Fill
                    </div>
                </div>

                <div id="uploadArea">
                    <label class="border-4 border-dashed border-slate-100 r-32 h-48 flex flex-col items-center justify-center cursor-pointer hover:border-blue-200 hover:bg-blue-50/20 transition-all group">
                        <input type="file" class="hidden" accept="image/*" id="fileInput" />
                        <svg class="w-8 h-8 text-slate-200 group-hover:text-blue-400 mb-2 transition-colors" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <span class="font-black text-slate-300 text-sm tracking-widest uppercase">拖放或點擊上傳圖片</span>
                        <span class="font-bold text-slate-200 text-[10px] mt-1 tracking-wider">支援拖放發票/帳單，自動識別欄位</span>
                    </label>
                </div>

                <div id="previewArea" class="hidden relative h-48 r-32 bg-slate-900 overflow-hidden shadow-2xl">
                    <img id="previewImage" src="" alt="preview" class="w-full h-full object-contain opacity-50" />
                    <div id="scanOverlay" class="absolute inset-0 hidden flex-col items-center justify-center bg-blue-900/40 backdrop-blur-md">
                        <svg class="w-8 h-8 animate-spin text-white mb-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                        <span class="text-white font-black text-xs tracking-widest animate-pulse uppercase italic">Syncing with AI Engine</span>
                    </div>
                    <!-- OCR 自動填入提示 -->
                    <div id="ocrResultBadge" class="absolute bottom-4 left-4 hidden bg-green-500/90 backdrop-blur-md text-white px-4 py-2 rounded-2xl text-[10px] font-black tracking-wider uppercase">
                        <svg class="w-3 h-3 inline-block mr-1" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                        已自動填入欄位
                    </div>
                    <button onclick="clearPreview()" class="absolute top-4 right-4 bg-white/20 hover:bg-white/40 p-2 rounded-full text-white backdrop-blur-md transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    </button>
                </div>
            </section>

            <!-- 萬海專屬：多圖批量核對 -->
            <section class="bg-white r-32 p-6 shadow-sm border border-slate-200 mb-6">
                <div class="flex items-center justify-between gap-3 mb-4">
                    <h3 class="text-sm font-black text-slate-800 uppercase tracking-tighter italic">憑證池 (Receipt Pool)</h3>
                    <label class="text-[10px] font-black px-3 py-2 rounded-xl bg-slate-100 text-slate-600 cursor-pointer hover:bg-blue-100 hover:text-blue-700 transition-all uppercase tracking-wider">
                        批次上傳
                        <input id="batchFileInput" type="file" class="hidden" accept="image/*" multiple />
                    </label>
                </div>
                <div id="receiptPool" class="flex flex-wrap gap-4 min-h-[100px] items-center justify-center border-2 border-dashed border-slate-100 rounded-3xl p-4 drop-zone">
                    <span id="receiptPoolPlaceholder" class="text-slate-300 font-bold text-[10px] uppercase tracking-widest">請批次拖放所有帳單與驗收單照片</span>
                </div>
            </section>

            <section class="bg-slate-900 text-white r-40 p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-lg font-black flex items-center gap-2 italic">自動解析清單 (Dynamic Batch Parsing)</h2>
                    <span id="rowCountTag" class="bg-blue-600 px-3 py-1 rounded-full text-[10px] font-black uppercase">0 Items</span>
                </div>
                <div id="dynamicList" class="space-y-4">
                    <div class="py-12 text-center text-slate-700 font-black italic">Waiting for Main Slip...</div>
                </div>
                <div class="mt-8 pt-6 border-t border-slate-800">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-black text-slate-500 uppercase">總計加總核對 (Check Sum)</span>
                        <span id="checkSumResult" class="text-sm font-black">$0 / $0</span>
                    </div>
                    <button id="batchSubmitBtn" disabled class="w-full py-5 r-24 font-black text-xl bg-slate-800 text-slate-600 cursor-not-allowed">解析未完成</button>
                </div>
            </section>

            <!-- 雙面板 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- 驗收單面板 -->
                <div class="bg-white r-40 p-8 shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-6 border-b pb-4 text-blue-600">
                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                        </svg>
                        <h3 class="font-black italic uppercase tracking-tighter">驗收單內容 (Slip)</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase tracking-widest">會計科目</label>
                            <input type="text" id="slipCode" value="M842" class="field-input" />
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase tracking-widest">帳單月份</label>
                            <input type="month" id="slipMonth" class="field-input" />
                        </div>
                    </div>

                    <!-- 漫遊 & 出差連動 -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <label class="flex items-center gap-2.5 p-3 rounded-xl bg-slate-50 border border-slate-100 cursor-pointer hover:bg-blue-50/50 transition-all group">
                            <input type="checkbox" id="isRoaming" class="w-4 h-4 rounded accent-blue-600" />
                            <div>
                                <span class="text-[10px] font-black text-slate-600 block group-hover:text-blue-600 transition-colors">包含國際漫遊</span>
                                <span class="text-[8px] font-bold text-slate-300">需配合出差事由</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-2.5 p-3 rounded-xl bg-slate-50 border border-slate-100 cursor-pointer hover:bg-blue-50/50 transition-all group">
                            <input type="checkbox" id="isBusinessTrip" class="w-4 h-4 rounded accent-blue-600" />
                            <div>
                                <span class="text-[10px] font-black text-slate-600 block group-hover:text-blue-600 transition-colors">出差事由</span>
                                <span class="text-[8px] font-bold text-slate-300">公務出差申請</span>
                            </div>
                        </label>
                    </div>

                    <div id="roamingAmountWrap" class="hidden mb-4">
                        <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase tracking-widest">國際漫遊金額</label>
                        <input type="text" id="roamingAmount" value="0" class="field-input" inputmode="numeric" />
                        <p id="roamingWarning" class="text-[10px] text-red-500 font-black mt-1 italic hidden">! 漫遊費用需配合出差申請方可核銷</p>
                    </div>

                    <div class="mt-4 p-6 bg-blue-50/50 rounded-3xl border border-blue-100/50">
                        <label class="text-[10px] font-black text-blue-400 uppercase mb-1 block">申報金額 (TWD)</label>
                        <input type="text" id="slipAmount" class="amount-input text-blue-700" placeholder="0" inputmode="numeric" />
                        <p id="overLimitWarning" class="text-[10px] text-red-600 font-black mt-2 hidden"></p>
                    </div>
                </div>

                <!-- 發票面板 -->
                <div class="bg-white r-40 p-8 shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-4 border-b pb-4 text-indigo-600">
                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
                        </svg>
                        <h3 class="font-black italic uppercase tracking-tighter">發票憑證 (Invoice)</h3>
                    </div>

                    <!-- [優化1] 發票拖放快速上傳 -->
                    <div id="invoiceDropZone" class="invoice-drop mb-4">
                        <input type="file" class="hidden" accept="image/*" id="invoiceFileInput" />
                        <div class="flex items-center justify-center gap-2 py-1">
                            <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            <span class="text-[10px] font-black text-slate-300 uppercase tracking-wider" id="invoiceDropLabel">拖放發票自動填入欄位</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase tracking-widest">憑證日期</label>
                            <input type="date" id="invoiceDate" class="field-input" />
                        </div>
                        <div id="invoiceMonthBox" class="p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-slate-50 text-slate-300 border-slate-100">
                            月份: --
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase tracking-widest">發票號碼</label>
                        <input type="text" id="invoiceNumber" class="field-input" placeholder="例：AB-12345678" />
                    </div>

                    <!-- 繳費 & 起訖章確認 -->
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <label class="flex items-center gap-2.5 p-3 rounded-xl border cursor-pointer transition-all" id="paidLabel"
                               style="background:#f8fafc;border-color:#e2e8f0;">
                            <input type="checkbox" id="isPaid" class="w-4 h-4 rounded accent-blue-600" />
                            <div>
                                <span class="text-[10px] font-black text-slate-600 block" id="paidText">已確認繳費</span>
                                <span class="text-[8px] font-bold text-slate-300" id="paidSub">點擊確認</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-2.5 p-3 rounded-xl border cursor-pointer transition-all" id="stampLabel"
                               style="background:#f8fafc;border-color:#e2e8f0;">
                            <input type="checkbox" id="hasStamp" class="w-4 h-4 rounded accent-blue-600" />
                            <div>
                                <span class="text-[10px] font-black text-slate-600 block" id="stampText">已核對起訖章</span>
                                <span class="text-[8px] font-bold text-slate-300" id="stampSub">點擊確認</span>
                            </div>
                        </label>
                    </div>

                    <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100">
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">憑證記載總額</label>
                        <input type="text" id="invoiceAmount" class="amount-input text-slate-700" placeholder="0" inputmode="numeric" />
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== 右側 (4 cols) ====== -->
        <div class="lg:col-span-4 space-y-6">

            <!-- Compliance Check -->
            <section class="bg-slate-900 text-white r-40 p-8 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-bl-full"></div>

                <h2 class="text-lg font-black mb-8 flex items-center gap-2 relative z-10 italic underline decoration-blue-500 underline-offset-8">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0 1 12 2.944a11.955 11.955 0 0 1-8.618 3.04A12.02 12.02 0 0 0 3 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    Compliance Check
                </h2>

                <div class="space-y-4 relative z-10" id="statusChecks"></div>

                <button id="submitBtn" onclick="handleSave()" disabled
                    class="w-full mt-10 py-5 r-24 font-black text-xl transition-all transform active:scale-95 shadow-2xl bg-slate-800 text-slate-600 cursor-not-allowed shadow-none">
                    資訊未齊全
                </button>
            </section>

            <!-- 個人歷史 -->
            <section class="bg-white r-32 p-6 shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-4 border-b pb-4">
                    <h3 class="text-sm font-black text-slate-800 flex items-center gap-2 uppercase tracking-tighter">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        個人申請歷史
                    </h3>
                    <svg class="w-4 h-4 text-slate-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                </div>
                <div id="historyList" class="space-y-3 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                    <div class="py-8 text-center text-slate-300 font-bold text-xs uppercase tracking-widest italic">Enter name to track history</div>
                </div>
            </section>
        </div>
    </main>

    <!-- ===== 成功 Modal ===== -->
    <div id="successModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-xl hidden items-center justify-center p-4 z-50">
        <div class="bg-white r-48 p-12 max-w-sm w-full text-center shadow-2xl scale-in">
            <div class="w-24 h-24 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner">
                <svg class="w-14 h-14" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <h3 class="text-3xl font-black text-slate-900 mb-2 tracking-tighter uppercase italic">Verified</h3>
            <p class="text-slate-400 font-bold text-[10px] mb-8 tracking-[0.5em] uppercase">Record Saved Successfully</p>
            <div id="modalSummary" class="bg-slate-50 rounded-3xl p-6 text-left mb-10 space-y-3 font-bold text-xs"></div>
            <button onclick="closeSuccessModal()" class="w-full py-5 bg-slate-900 text-white rounded-3xl font-black text-lg hover:bg-blue-600 transition-all shadow-xl">處理下一筆</button>
        </div>
    </div>

    <footer class="max-w-7xl mx-auto mt-12 py-8 text-center text-slate-300 font-black text-[10px] tracking-[0.8em] uppercase opacity-40">
        AI Intelligent Auditor &bull; Persistence
    </footer>

    <script>
    // ============================================================
    // 狀態管理
    // ============================================================
    let records = JSON.parse(localStorage.getItem('expenseRecords') || '[]');
    let profiles = JSON.parse(localStorage.getItem('employeeProfiles') || '{}');
    let pool = [];
    let mainSlipData = null;
    let autoExtractedRows = [];
    // isPaid / hasStamp 現在由 checkbox 控制，不需額外變數

    const roleLimits = { manager: 1399, staff: 800, special: 500 };
    const roleLabels = { manager: '主管', staff: '一般員工', special: '特定專案' };
    const monthNames = ['01','02','03','04','05','06','07','08','09','10','11','12'];

    const $ = id => document.getElementById(id);

    // ============================================================
    // [優化3] 金額千分位格式化
    // ============================================================
    function formatAmount(value) {
        const num = parseRawAmount(value);
        if (isNaN(num) || num === 0) return '';
        return num.toLocaleString('en-US');
    }

    function parseRawAmount(value) {
        if (typeof value === 'number') return value;
        return parseFloat(String(value).replace(/,/g, '')) || 0;
    }

    function setupAmountInput(el) {
        el.addEventListener('input', function() {
            const pos = this.selectionStart;
            const oldLen = this.value.length;
            const raw = this.value.replace(/[^0-9.]/g, '');

            if (raw === '' || raw === '.') {
                this.value = raw;
                return;
            }

            // 保持只有一個小數點
            const parts = raw.split('.');
            let formatted;
            if (parts.length > 1) {
                formatted = parseFloat(parts[0] || '0').toLocaleString('en-US') + '.' + parts[1];
            } else {
                formatted = parseFloat(raw).toLocaleString('en-US');
            }

            this.value = formatted;

            // 恢復游標位置
            const newLen = this.value.length;
            const newPos = pos + (newLen - oldLen);
            this.setSelectionRange(newPos, newPos);

            runValidation();
        });

        el.addEventListener('blur', function() {
            const num = parseRawAmount(this.value);
            if (num > 0) {
                this.value = num.toLocaleString('en-US');
            } else {
                this.value = '';
            }
        });
    }

    // ============================================================
    // 初始化
    // ============================================================
    function init() {
        const now = new Date();
        $('slipMonth').value = now.toISOString().slice(0, 7);

        // 綁定即時驗證 — 文字 / 選擇欄位
        ['employeeName', 'slipCode', 'slipMonth', 'invoiceDate'].forEach(id => {
            $(id).addEventListener('input', runValidation);
            $(id).addEventListener('change', runValidation);
        });

        // 金額欄位：千分位格式化
        setupAmountInput($('slipAmount'));
        setupAmountInput($('invoiceAmount'));
        setupAmountInput($('roamingAmount'));

        $('userRole').addEventListener('change', runValidation);

        // 漫遊 checkbox → 顯示/隱藏漫遊金額欄
        $('isRoaming').addEventListener('change', () => {
            $('roamingAmountWrap').classList.toggle('hidden', !$('isRoaming').checked);
            if (!$('isRoaming').checked) $('roamingAmount').value = '0';
            runValidation();
        });

        // 出差 checkbox
        $('isBusinessTrip').addEventListener('change', runValidation);

        // 繳費 & 起訖章 checkbox → 視覺反饋 + 驗證
        $('isPaid').addEventListener('change', () => {
            updateCheckboxLabel('isPaid', 'paidLabel', 'paidText', 'paidSub', '已確認繳費', '繳費已確認', '點擊確認');
            runValidation();
        });
        $('hasStamp').addEventListener('change', () => {
            updateCheckboxLabel('hasStamp', 'stampLabel', 'stampText', 'stampSub', '已核對起訖章', '起訖章已確認', '點擊確認');
            runValidation();
        });

        // 姓名 → 載入身分
        $('employeeName').addEventListener('input', () => {
            const name = $('employeeName').value.trim();
            if (name && profiles[name]) {
                $('userRole').value = profiles[name].role;
                $('identityBadge').classList.remove('hidden');
            } else {
                $('identityBadge').classList.add('hidden');
            }
            renderHistory();
        });

        // 圖片上傳
        $('fileInput').addEventListener('change', e => handleFileUpload(e, 'main'));
        setupDragDrop($('mainDropZone'), file => processUpload(file, 'main'));

        // 發票專屬拖放
        const invDrop = $('invoiceDropZone');
        invDrop.addEventListener('click', () => $('invoiceFileInput').click());
        $('invoiceFileInput').addEventListener('change', e => {
            if (e.target.files[0]) processUpload(e.target.files[0], 'invoice');
        });
        setupDragDrop(invDrop, file => processUpload(file, 'invoice'));

        // 萬海批量憑證池
        $('batchFileInput').addEventListener('change', e => {
            if (e.target.files?.length) handleBatchUpload(e.target.files);
            e.target.value = '';
        });
        const receiptPoolEl = $('receiptPool');
        receiptPoolEl.addEventListener('click', () => $('batchFileInput').click());
        setupMultiDragDrop(receiptPoolEl, files => handleBatchUpload(files));

        runValidation();
        renderHistory();
        updateStats();
    }

    // checkbox 視覺反饋
    function updateCheckboxLabel(cbId, labelId, textId, subId, offText, onText, offSub) {
        const checked = $(cbId).checked;
        const label = $(labelId);
        label.style.background = checked ? '#eff6ff' : '#f8fafc';
        label.style.borderColor = checked ? '#93c5fd' : '#e2e8f0';
        $(textId).textContent = checked ? onText : offText;
        $(textId).classList.toggle('text-blue-600', checked);
        $(textId).classList.toggle('text-slate-600', !checked);
        $(subId).textContent = checked ? '已確認 ✓' : offSub;
        $(subId).classList.toggle('text-blue-400', checked);
        $(subId).classList.toggle('text-slate-300', !checked);
    }

    // ============================================================
    // [優化1] 拖放處理
    // ============================================================
    function setupDragDrop(el, onFile) {
        ['dragenter', 'dragover'].forEach(evt => {
            el.addEventListener(evt, e => { e.preventDefault(); el.classList.add('drag-over'); });
        });
        ['dragleave', 'drop'].forEach(evt => {
            el.addEventListener(evt, e => { e.preventDefault(); el.classList.remove('drag-over'); });
        });
        el.addEventListener('drop', e => {
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) onFile(file);
        });
    }

    function processUpload(file, target) {
        const reader = new FileReader();
        reader.onloadend = () => {
            // 顯示預覽
            $('uploadArea').classList.add('hidden');
            $('previewArea').classList.remove('hidden');
            $('previewImage').src = reader.result;
            $('scanOverlay').classList.remove('hidden');
            $('scanOverlay').classList.add('flex');

            // 模擬 OCR（2 秒後自動填入 demo 資料）
            setTimeout(() => {
                $('scanOverlay').classList.add('hidden');
                $('scanOverlay').classList.remove('flex');

                if (target === 'invoice') {
                    simulateInvoiceOCR();
                    $('invoiceDropZone').classList.add('has-file');
                    $('invoiceDropLabel').textContent = '發票已上傳 — 已自動填入';
                } else {
                    simulateSlipOCR();
                }

                $('ocrResultBadge').classList.remove('hidden');
                setTimeout(() => $('ocrResultBadge').classList.add('hidden'), 3000);

                showToast('圖片已辨識，欄位已自動填入', 'success');
                runValidation();
            }, 2000);
        };
        reader.readAsDataURL(file);
    }

    function simulateInvoiceOCR() {
        // demo：模擬填入發票欄位
        const today = new Date();
        const dateStr = today.toISOString().slice(0, 10);
        $('invoiceDate').value = dateStr;
        $('invoiceNumber').value = 'AB-' + String(Math.floor(10000000 + Math.random() * 90000000));

        // 如果申報金額已填，同步發票金額
        const slipVal = parseRawAmount($('slipAmount').value);
        if (slipVal > 0) {
            $('invoiceAmount').value = slipVal.toLocaleString('en-US');
        }
    }

    function simulateSlipOCR() {
        $('slipCode').value = 'M842';
        const today = new Date();
        $('slipMonth').value = today.toISOString().slice(0, 7);
    }

    function handleFileUpload(e, target) {
        const file = e.target.files[0];
        if (file) processUpload(file, target);
    }

    function clearPreview() {
        $('previewArea').classList.add('hidden');
        $('uploadArea').classList.remove('hidden');
        $('previewImage').src = '';
        $('fileInput').value = '';
        $('invoiceFileInput').value = '';
        $('ocrResultBadge').classList.add('hidden');
        $('invoiceDropZone').classList.remove('has-file');
        $('invoiceDropLabel').textContent = '拖放發票自動填入欄位';
    }

    function detectMonth(fileName) {
        const hit = fileName.match(/(20\d{2})[-_]?([01]\d)/);
        if (!hit) return null;
        return `${hit[1]}-${hit[2]}`;
    }

    function setupMultiDragDrop(el, onFiles) {
        ['dragenter', 'dragover'].forEach(evt => {
            el.addEventListener(evt, e => { e.preventDefault(); el.classList.add('drag-over'); });
        });
        ['dragleave', 'drop'].forEach(evt => {
            el.addEventListener(evt, e => { e.preventDefault(); el.classList.remove('drag-over'); });
        });
        el.addEventListener('drop', e => {
            const files = Array.from(e.dataTransfer.files || []).filter(file => file.type.startsWith('image/'));
            if (files.length) onFiles(files);
        });
    }

    function handleBatchUpload(files) {
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const doc = {
                    id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                    src: e.target.result,
                    name: file.name,
                    month: detectMonth(file.name),
                    isMain: file.name.includes('驗收單')
                };
                pool.push(doc);
                renderPool();
                if (doc.isMain) parseWanHaiSlip(doc);
                else autoMatchReceipts();
            };
            reader.readAsDataURL(file);
        });
    }

    function renderPool() {
        const wrap = $('receiptPool');
        if (pool.length === 0) {
            wrap.innerHTML = '<span id="receiptPoolPlaceholder" class="text-slate-300 font-bold text-[10px] uppercase tracking-widest">請批次拖放所有帳單與驗收單照片</span>';
            return;
        }

        wrap.innerHTML = pool.map(item => `
            <div class="w-[120px] rounded-2xl border ${item.isMain ? 'border-blue-300 bg-blue-50/60' : 'border-slate-200 bg-white'} p-2 shadow-sm">
                <img src="${item.src}" alt="${item.name}" class="w-full h-16 object-cover rounded-xl mb-2" />
                <p class="text-[9px] font-black truncate ${item.isMain ? 'text-blue-700' : 'text-slate-500'}">${item.isMain ? 'MAIN' : 'INVOICE'} • ${item.month || '--'}</p>
                <p class="text-[9px] font-bold text-slate-400 truncate">${item.name}</p>
            </div>
        `).join('');
    }

    function parseWanHaiSlip(doc) {
        const extractedLines = [
            { code: 'M842', month: '2025-09', amt: 800, remark: '電信費' },
            { code: 'M842', month: '2025-10', amt: 800, remark: '電信費' },
            { code: 'M842', month: '2025-11', amt: 800, remark: '電信費' },
            { code: 'M842', month: '2025-12', amt: 800, remark: '電信費' },
            { code: 'M842', month: '2026-01', amt: 800, remark: '電信費' },
            { code: 'M842', month: '2026-01', amt: 597, remark: '香港出差漫遊', isRoaming: true }
        ];

        autoExtractedRows = extractedLines;
        mainSlipData = {
            id: doc.id,
            grandTotal: extractedLines.reduce((sum, line) => sum + line.amt, 0)
        };
        renderDynamicList(extractedLines);
        showToast('已解析主驗收單，完成 M842 明細拆分', 'info');
    }

    function renderDynamicList(lines) {
        const list = $('dynamicList');
        const role = $('userRole').value;
        const limit = roleLimits[role];
        const isTrip = $('isBusinessTrip').checked;

        list.innerHTML = lines.map((line, i) => {
            const isOver = line.amt > limit;
            const roamingPass = line.isRoaming ? isTrip : true;
            const hasInvoice = pool.some(p => p.month === line.month && !p.isMain);
            const statusText = !roamingPass
                ? '⚠️ 需核對出差證明'
                : (hasInvoice ? '已匹配憑證 ✓' : '缺少憑證 ❌');

            return `
                <div class="check-item p-4 bg-white/5 rounded-3xl border ${hasInvoice ? 'border-emerald-500/30' : 'border-white/10'} mb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-[9px] font-black text-blue-500 uppercase">Line #${i + 1} • ${line.code}</span>
                            <p class="text-xs font-black text-white">${line.month} ${line.remark}</p>
                            ${isOver ? `<p class="text-[9px] text-red-500 font-bold">▲ 超過職級上限 ${limit}</p>` : '<p class="text-[9px] text-emerald-400 font-bold">額度內通過</p>'}
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black ${isOver ? 'text-red-500' : 'text-white'}">$${line.amt}</p>
                            <span class="text-[9px] font-bold ${(!roamingPass || !hasInvoice) ? 'text-amber-400' : 'text-emerald-400'}">${statusText}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        $('rowCountTag').textContent = `${lines.length} Items Detected`;
        autoMatchReceipts();
    }

    function autoMatchReceipts() {
        if (!autoExtractedRows.length) return;
        updateBatchStatus(autoExtractedRows);
    }

    function updateBatchStatus(lines) {
        const isTrip = $('isBusinessTrip').checked;
        const role = $('userRole').value;
        const limit = roleLimits[role];

        const total = lines.reduce((sum, line) => sum + line.amt, 0);
        const grandTotal = mainSlipData?.grandTotal || 0;
        const checkSumPass = total === grandTotal;

        const allRulesPass = lines.every(line => {
            const hasInvoice = pool.some(p => p.month === line.month && !p.isMain);
            const rolePass = line.amt <= limit;
            const roamingPass = line.isRoaming ? isTrip : true;
            return hasInvoice && rolePass && roamingPass;
        });

        const btn = $('batchSubmitBtn');
        $('checkSumResult').textContent = `$${total.toLocaleString()} / $${grandTotal.toLocaleString()}`;
        $('checkSumResult').className = `text-sm font-black ${checkSumPass ? 'text-emerald-400' : 'text-red-400'}`;

        if (checkSumPass && allRulesPass && lines.length > 0) {
            btn.disabled = false;
            btn.className = 'w-full py-5 r-24 font-black text-xl bg-blue-600 text-white hover:bg-blue-500 transition-all';
            btn.textContent = '批量核對完成，可送出';
        } else {
            btn.disabled = true;
            btn.className = 'w-full py-5 r-24 font-black text-xl bg-slate-800 text-slate-600 cursor-not-allowed';
            btn.textContent = checkSumPass ? '尚有明細待補件' : '總計不一致，需複核';
        }
    }

    // ============================================================
    // 語意化錯誤訊息產生器（整合新規則引擎）
    // ============================================================
    function getFixHint(key, data) {
        switch (key) {
            case 'name':
                return { type: 'err', text: '請在上方輸入員工姓名或編號' };
            case 'limit':
                if (data.slipAmt === 0) return { type: 'warn', text: '尚未輸入申報金額' };
                return {
                    type: 'err',
                    text: `${roleLabels[data.role]}額度上限為 $${data.limit.toLocaleString()}，目前申報 $${data.slipAmt.toLocaleString()} 超出 $${(data.slipAmt - data.limit).toLocaleString()}，請調整金額或變更職級`
                };
            case 'roaming':
                return { type: 'err', text: `已勾選包含國際漫遊，但尚未勾選「出差事由」。漫遊費用需配合出差申請方可核銷` };
            case 'paid':
                return { type: 'warn', text: '請在發票憑證區勾選「已確認繳費」' };
            case 'subject':
                if (data.expense !== '網路費用' && !data.monthMatch) {
                    return { type: 'err', text: `費用科目須為「網路費用」(代碼 M842)，且月份須一致。目前科目代碼「${data.code}」${!data.invMonth ? '，發票日期尚未填寫' : `，發票月份 ${data.invMonth.split('-')[1]} 月與帳單月份 ${data.slipMonth.split('-')[1]} 月不符`}` };
                }
                if (data.expense !== '網路費用') {
                    return { type: 'err', text: `會計科目代碼須為「M842」（網路費用），目前輸入「${data.code}」` };
                }
                if (!data.slipMonth) return { type: 'warn', text: '請選擇帳單月份' };
                if (!data.invMonth) return { type: 'warn', text: '請填寫發票憑證日期' };
                return {
                    type: 'err',
                    text: `發票月份為 ${data.invMonth.split('-')[1]} 月，與帳單月份 ${data.slipMonth.split('-')[1]} 月不符，請確認日期是否正確`
                };
            case 'amount':
                if (data.slipAmt === 0 && data.invAmt === 0) return { type: 'warn', text: '尚未輸入金額，請填寫申報金額與憑證總額' };
                if (data.slipAmt === 0) return { type: 'warn', text: '請在驗收單填寫申報金額' };
                if (data.invAmt === 0) return { type: 'warn', text: '請在發票憑證填寫憑證記載總額' };
                return {
                    type: 'err',
                    text: `申報金額 $${data.slipAmt.toLocaleString()} 與憑證總額 $${data.invAmt.toLocaleString()} 差額 $${Math.abs(data.slipAmt - data.invAmt).toLocaleString()}，請確認後修正`
                };
            case 'stamp':
                return { type: 'warn', text: '請在發票憑證區勾選「已核對起訖章」以確認憑證完整性' };
            default:
                return null;
        }
    }

    // ============================================================
    // 核心驗證（整合新規則引擎：職級限額 / 漫遊連動 / 繳費確認 / 科目月份）
    // ============================================================
    function runValidation() {
        const name = $('employeeName').value.trim();
        const code = $('slipCode').value.trim().toUpperCase();
        const slipMonth = $('slipMonth').value;
        const slipAmt = parseRawAmount($('slipAmount').value);
        const invDate = $('invoiceDate').value;
        const invAmt = parseRawAmount($('invoiceAmount').value);
        const roaming = parseRawAmount($('roamingAmount').value);
        const role = $('userRole').value;
        const limit = roleLimits[role];
        const isRoaming = $('isRoaming').checked;
        const isTrip = $('isBusinessTrip').checked;
        const paidChecked = $('isPaid').checked;
        const invMonth = invDate ? invDate.slice(0, 7) : null;

        // ===== 4 項核心規則（對應用戶提供的規則引擎）=====

        // 規則 1: 職級限額驗證
        const limitPass = slipAmt > 0 && slipAmt <= limit;

        // 規則 2: 漫遊申請資格（勾選漫遊 → 必須勾選出差）
        const roamingPass = isRoaming ? isTrip : true;

        // 規則 3: 繳費狀態核對
        const paidPass = paidChecked;

        // 規則 4: 科目與月份（代碼 M842 + 月份一致）
        const isCodeM842 = code === 'M842';
        const monthMatch = !!(slipMonth && invMonth && slipMonth === invMonth);
        const subjectPass = isCodeM842 && monthMatch;

        // ===== 額外輔助驗證 =====
        const isNameOK = !!name;
        const isAmountMatch = slipAmt > 0 && slipAmt === invAmt;

        // ===== 視覺反饋 =====

        // 代碼欄位
        $('slipCode').classList.toggle('field-warning', code !== '' && !isCodeM842);

        // 金額超限
        $('slipAmount').classList.toggle('text-red-600', slipAmt > limit);
        $('slipAmount').classList.toggle('text-blue-700', slipAmt <= limit);
        const overWarn = $('overLimitWarning');
        if (slipAmt > limit) {
            overWarn.textContent = `▲ 超過${roleLabels[role]}限額 $${limit.toLocaleString()}，超出 $${(slipAmt - limit).toLocaleString()}`;
            overWarn.classList.remove('hidden', 'text-emerald-500');
            overWarn.classList.add('text-red-600');
        } else if (slipAmt > 0) {
            overWarn.textContent = `✓ ${roleLabels[role]}限額 $${limit.toLocaleString()}，剩餘額度 $${(limit - slipAmt).toLocaleString()}`;
            overWarn.classList.remove('hidden', 'text-red-600');
            overWarn.classList.add('text-emerald-500');
        } else {
            overWarn.classList.add('hidden');
            overWarn.classList.remove('text-emerald-500', 'text-red-600');
        }

        // 漫遊警告
        $('roamingWarning').classList.toggle('hidden', !isRoaming || isTrip);

        // 月份 box
        const box = $('invoiceMonthBox');
        if (invDate) {
            if (monthMatch) {
                box.className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-green-50 text-green-600 border-green-100';
            } else {
                box.className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-red-50 text-red-500 border-red-100';
            }
            box.textContent = '月份: ' + invMonth;
        } else {
            box.className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-slate-50 text-slate-300 border-slate-100';
            box.textContent = '月份: --';
        }

        // 共用資料
        const expense = isCodeM842 ? '網路費用' : code;
        const hintData = { slipAmt, invAmt, code, expense, slipMonth, invMonth, role, limit, roaming, monthMatch };

        // ===== Compliance Check 面板 =====
        const checks = [
            { key: 'name', active: isNameOK, label: '已確認姓名', detail: name || 'MISSING' },
            { key: 'amount', active: isAmountMatch, label: '金額核對', detail: isAmountMatch ? 'MATCH' : (slipAmt > 0 || invAmt > 0 ? `DIFF $${Math.abs(slipAmt - invAmt).toLocaleString()}` : 'EMPTY') },
            { type: 'hr' },
            { key: 'limit', active: limitPass, label: '職級限額驗證', detail: limitPass ? `符合 (${limit})` : (slipAmt > limit ? `超出上限 (${limit})` : 'EMPTY') },
            { key: 'roaming', active: roamingPass, label: '漫遊申請資格', detail: !isRoaming ? '不適用' : (roamingPass ? '符合事由' : '需出差事由') },
            { key: 'paid', active: paidPass, label: '繳費狀態核對', detail: paidPass ? '已確認繳費' : '尚未確認' },
            { key: 'subject', active: subjectPass, label: '科目與月份', detail: subjectPass ? '核對通過' : (isCodeM842 ? '月份不符' : '科目錯誤') },
            { key: 'stamp', active: $('hasStamp').checked, label: '起訖章核對', detail: $('hasStamp').checked ? '已確認' : '尚未確認' },
        ];

        const iconOK = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';
        const iconFail = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';

        $('statusChecks').innerHTML = checks.map(c => {
            if (c.type === 'hr') return '<hr class="border-slate-800 my-1" />';

            let hintHTML = '';
            if (!c.active) {
                const hint = getFixHint(c.key, hintData);
                if (hint) {
                    const hIcon = hint.type === 'err'
                        ? '<svg class="w-3 h-3 flex-shrink-0 mt-px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
                        : '<svg class="w-3 h-3 flex-shrink-0 mt-px" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
                    const bg = hint.type === 'err' ? 'bg-red-500/10 text-red-400' : 'bg-amber-500/10 text-amber-400';
                    hintHTML = `<div class="mt-2 ${bg} rounded-lg px-3 py-2 text-[10px] font-bold flex items-start gap-1.5 leading-relaxed">${hIcon}<span>${hint.text}</span></div>`;
                }
            }

            const idx = checks.indexOf(c);
            return `
                <div class="check-item" style="animation-delay:${idx * 40}ms">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="status-dot ${c.active ? 'on' : 'off'}">${c.active ? iconOK : iconFail}</div>
                            <span class="font-black text-xs uppercase tracking-tighter ${c.active ? 'text-white' : 'text-slate-600'}">${c.label}</span>
                        </div>
                        <span class="text-[9px] font-black italic tracking-widest ${c.active ? 'text-blue-400 underline underline-offset-4' : 'text-slate-800'}">${c.detail}</span>
                    </div>
                    ${hintHTML}
                </div>
            `;
        }).join('');

        if (autoExtractedRows.length) {
            renderDynamicList(autoExtractedRows);
        }

        // 按鈕（全部 7 項通過才可提交）
        const stampPass = $('hasStamp').checked;
        const canSubmit = isNameOK && isAmountMatch && limitPass && roamingPass && paidPass && subjectPass && stampPass;
        const btn = $('submitBtn');
        if (canSubmit) {
            btn.disabled = false;
            btn.className = 'w-full mt-10 py-5 r-24 font-black text-xl transition-all transform active:scale-95 shadow-2xl bg-blue-600 text-white hover:bg-blue-500 cursor-pointer shadow-blue-500/30';
            btn.textContent = '核對無誤 • 儲存進度';
        } else {
            btn.disabled = true;
            btn.className = 'w-full mt-10 py-5 r-24 font-black text-xl transition-all transform active:scale-95 shadow-2xl bg-slate-800 text-slate-600 cursor-not-allowed shadow-none';
            const passCount = [isNameOK, isAmountMatch, limitPass, roamingPass, paidPass, subjectPass, stampPass].filter(Boolean).length;
            btn.textContent = `資訊未齊全 (${passCount}/7)`;
        }
    }

    // ============================================================
    // [優化2] 統計更新
    // ============================================================
    function updateStats() {
        const now = new Date();
        const thisMonth = now.toISOString().slice(0, 7);
        const thisMonthRecords = records.filter(r => r.month === thisMonth);
        const total = records.length;
        const passCount = records.filter(r => r.isPaid).length;
        const totalAmt = records.reduce((s, r) => s + (parseFloat(r.slipData.amount) || 0), 0);

        $('statThisMonth').textContent = thisMonthRecords.length;
        $('statPassRate').textContent = total > 0 ? Math.round((passCount / total) * 100) + '%' : '--';
        $('statTotalAmt').textContent = '$' + totalAmt.toLocaleString();
        $('statTotalCount').textContent = total;
    }

    // ============================================================
    // 儲存
    // ============================================================
    function handleSave() {
        const name = $('employeeName').value.trim();
        const role = $('userRole').value;
        const code = $('slipCode').value.trim();
        const month = $('slipMonth').value;
        const amount = parseRawAmount($('slipAmount').value);
        const roaming = parseRawAmount($('roamingAmount').value);
        const invDate = $('invoiceDate').value;
        const invAmt = parseRawAmount($('invoiceAmount').value);
        const invNum = $('invoiceNumber').value.trim();

        // 儲存員工檔案
        profiles[name] = { name, role, lastActive: new Date().toISOString() };
        localStorage.setItem('employeeProfiles', JSON.stringify(profiles));

        // 儲存紀錄
        const record = {
            id: `${name}_${month}_${Date.now()}`,
            employeeName: name,
            userRole: role,
            slipData: { code, month, amount: String(amount), roamingAmount: String(roaming) },
            invoiceData: { date: invDate, amount: String(invAmt), number: invNum },
            isRoaming: $('isRoaming').checked,
            isBusinessTrip: $('isBusinessTrip').checked,
            isPaid: $('isPaid').checked,
            hasStamp: $('hasStamp').checked,
            createdAt: new Date().toISOString(),
            month
        };

        records.unshift(record);
        localStorage.setItem('expenseRecords', JSON.stringify(records));

        // Modal
        $('modalSummary').innerHTML = `
            <p class="flex justify-between"><span>申請人：</span><span class="text-slate-900 font-black italic underline decoration-blue-500">${name}</span></p>
            <p class="flex justify-between"><span>身分：</span><span class="text-slate-500">${roleLabels[role]}</span></p>
            <p class="flex justify-between"><span>金額：</span><span class="text-blue-600 font-black">$ ${amount.toLocaleString()}</span></p>
            <p class="flex justify-between"><span>月份：</span><span class="text-slate-500">${month}</span></p>
            ${invNum ? `<p class="flex justify-between"><span>發票：</span><span class="text-slate-500">${invNum}</span></p>` : ''}
            ${roaming > 0 ? `<p class="flex justify-between"><span>漫遊：</span><span class="text-amber-500 font-black">$ ${roaming.toLocaleString()}</span></p>` : ''}
        `;

        $('successModal').classList.remove('hidden');
        $('successModal').classList.add('flex');

        renderHistory();
        updateStats();
        showToast('驗證通過！紀錄已儲存', 'success');
    }

    function closeSuccessModal() {
        $('successModal').classList.add('hidden');
        $('successModal').classList.remove('flex');
        clearPreview();

        $('slipAmount').value = '';
        $('invoiceAmount').value = '';
        $('invoiceDate').value = '';
        $('invoiceNumber').value = '';
        $('roamingAmount').value = '0';
        $('isRoaming').checked = false;
        $('isBusinessTrip').checked = false;
        $('isPaid').checked = false;
        $('hasStamp').checked = false;
        $('roamingAmountWrap').classList.add('hidden');
        // 重設 checkbox label 狀態
        updateCheckboxLabel('isPaid', 'paidLabel', 'paidText', 'paidSub', '已確認繳費', '繳費已確認', '點擊確認');
        updateCheckboxLabel('hasStamp', 'stampLabel', 'stampText', 'stampSub', '已核對起訖章', '起訖章已確認', '點擊確認');
        $('invoiceMonthBox').className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-slate-50 text-slate-300 border-slate-100';
        $('invoiceMonthBox').textContent = '月份: --';
        runValidation();
    }

    // ============================================================
    // 歷史
    // ============================================================
    function renderHistory() {
        const name = $('employeeName').value.trim();
        const list = $('historyList');

        if (!name) {
            list.innerHTML = '<div class="py-8 text-center text-slate-300 font-bold text-xs uppercase tracking-widest italic">Enter name to track history</div>';
            return;
        }

        const history = records.filter(r => r.employeeName === name).sort((a, b) => b.month.localeCompare(a.month));

        if (history.length === 0) {
            list.innerHTML = '<div class="py-10 text-center text-slate-300 font-bold italic text-xs uppercase">No history records</div>';
            return;
        }

        list.innerHTML = history.map(r => {
            const roam = parseFloat(r.slipData.roamingAmount) || 0;
            const amt = parseFloat(r.slipData.amount) || 0;
            return `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl hover:bg-blue-50 transition-colors">
                    <div>
                        <p class="text-[10px] font-black text-slate-900 italic tracking-tighter">${r.month}</p>
                        <p class="text-[9px] font-bold text-slate-400">${r.slipData.code}${r.invoiceData.number ? ' • ' + r.invoiceData.number : ''}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-blue-600">$${amt.toLocaleString()}</p>
                        <p class="text-[8px] font-black uppercase ${roam > 0 ? 'text-amber-500' : 'text-slate-300'}">
                            ${roam > 0 ? 'Roaming Incl.' : 'Std Fee'}
                        </p>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ============================================================
    // Toast
    // ============================================================
    function showToast(message, type = 'info') {
        const container = $('toastContainer');
        const colors = {
            success: 'bg-green-50 border-green-200 text-green-700',
            error: 'bg-red-50 border-red-200 text-red-700',
            info: 'bg-blue-50 border-blue-200 text-blue-700'
        };
        const icons = {
            success: '<polyline points="22 4 12 14.01 9 11.01"/>',
            error: '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>',
            info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
        };

        const toast = document.createElement('div');
        toast.className = `toast-anim ${colors[type]} border rounded-2xl px-5 py-3 flex items-center gap-3 shadow-lg font-bold text-sm`;
        toast.innerHTML = `<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${icons[type]}</svg>${message}`;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            toast.style.transition = 'all 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ============================================================
    // 啟動
    // ============================================================
    init();
    </script>
</body>
</html>
