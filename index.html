<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>費用核銷驗證系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }

        /* 浮動背景光暈 */
        .bg-glow {
            position: fixed;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
        }
        .bg-glow-1 { width: 600px; height: 600px; background: #6366f1; top: -200px; left: -100px; }
        .bg-glow-2 { width: 500px; height: 500px; background: #06b6d4; bottom: -150px; right: -100px; }
        .bg-glow-3 { width: 400px; height: 400px; background: #8b5cf6; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* 玻璃擬態卡片 */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /* 輸入框樣式 */
        .form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }
        .form-input::placeholder { color: rgba(148, 163, 184, 0.6); }

        .form-input.input-error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
        }
        .form-input.input-success {
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
        }

        /* 按鈕動畫 */
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }
        .btn-primary:active { transform: translateY(0); }
        .btn-primary::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.1) 100%);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* 狀態標籤 */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-pending { background: rgba(234, 179, 8, 0.15); color: #facc15; }
        .badge-approved { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
        .badge-rejected { background: rgba(239, 68, 68, 0.15); color: #f87171; }

        /* 表格樣式 */
        .data-table tr { transition: all 0.2s ease; }
        .data-table tbody tr:hover { background: rgba(255, 255, 255, 0.03); }

        /* 提示訊息動畫 */
        .toast {
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* 淡入動畫 */
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 載入脈動 */
        .pulse-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }

        /* Modal 遮罩 */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
        }

        /* 驗證結果面板 */
        .validation-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            overflow: hidden;
        }

        .validation-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            transition: background 0.2s ease;
        }
        .validation-item:last-child { border-bottom: none; }
        .validation-item:hover { background: rgba(255, 255, 255, 0.02); }

        .check-icon { color: #4ade80; }
        .cross-icon { color: #f87171; }

        /* 數字統計動畫 */
        .stat-number {
            background: linear-gradient(135deg, #e2e8f0, #f8fafc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* 滾動條 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="text-slate-200">

    <!-- 背景光暈 -->
    <div class="bg-glow bg-glow-1"></div>
    <div class="bg-glow bg-glow-2"></div>
    <div class="bg-glow bg-glow-3"></div>

    <!-- 提示訊息容器 -->
    <div id="toastContainer" class="fixed top-6 right-6 z-50 flex flex-col gap-3"></div>

    <!-- 頂部導覽列 -->
    <header class="relative z-10 border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-tight">費用核銷驗證系統</h1>
                    <p class="text-xs text-slate-400">Invoice Verification System</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 text-xs text-slate-400">
                    <div class="pulse-dot bg-emerald-400"></div>
                    <span>系統運行中</span>
                </div>
                <div class="text-xs text-slate-500" id="currentDateTime"></div>
            </div>
        </div>
    </header>

    <!-- 主內容區 -->
    <main class="relative z-10 max-w-7xl mx-auto px-6 py-8">

        <!-- 統計卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 fade-in">
            <div class="glass-card rounded-2xl p-5">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-slate-400 font-medium uppercase tracking-wider">待驗證</span>
                    <div class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <div class="text-2xl font-bold stat-number" id="statPending">0</div>
            </div>
            <div class="glass-card rounded-2xl p-5">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-slate-400 font-medium uppercase tracking-wider">已通過</span>
                    <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                </div>
                <div class="text-2xl font-bold stat-number" id="statApproved">0</div>
            </div>
            <div class="glass-card rounded-2xl p-5">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-slate-400 font-medium uppercase tracking-wider">未通過</span>
                    <div class="w-8 h-8 rounded-lg bg-red-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </div>
                </div>
                <div class="text-2xl font-bold stat-number" id="statRejected">0</div>
            </div>
            <div class="glass-card rounded-2xl p-5">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-slate-400 font-medium uppercase tracking-wider">總筆數</span>
                    <div class="w-8 h-8 rounded-lg bg-indigo-500/10 flex items-center justify-center">
                        <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                </div>
                <div class="text-2xl font-bold stat-number" id="statTotal">0</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- 左側：表單 -->
            <div class="lg:col-span-1 fade-in" style="animation-delay: 0.1s;">
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center">
                            <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                        </div>
                        <h2 class="text-base font-semibold text-white">新增核銷驗證</h2>
                    </div>

                    <form id="verifyForm" class="space-y-4" onsubmit="return false;">
                        <!-- 確認代碼 -->
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5">確認代碼 <span class="text-red-400">*</span></label>
                            <input type="text" id="confirmCode" class="form-input w-full px-4 py-2.5 rounded-xl text-sm" placeholder="請輸入確認代碼" autocomplete="off">
                            <p class="text-xs mt-1.5 text-slate-500" id="codeHint">系統將驗證代碼是否正確</p>
                        </div>

                        <!-- 費用項目 -->
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5">費用項目 <span class="text-red-400">*</span></label>
                            <select id="expenseType" class="form-input w-full px-4 py-2.5 rounded-xl text-sm appearance-none cursor-pointer">
                                <option value="">請選擇費用項目</option>
                                <option value="網路費用">網路費用</option>
                                <option value="辦公用品">辦公用品</option>
                                <option value="交通費用">交通費用</option>
                                <option value="餐飲費用">餐飲費用</option>
                                <option value="設備維護">設備維護</option>
                            </select>
                        </div>

                        <!-- 核銷金額 -->
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5">核銷金額 (NT$) <span class="text-red-400">*</span></label>
                            <input type="number" id="amount" class="form-input w-full px-4 py-2.5 rounded-xl text-sm" placeholder="請輸入金額" min="0">
                        </div>

                        <!-- 核銷月份 -->
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5">核銷月份 <span class="text-red-400">*</span></label>
                            <input type="month" id="claimMonth" class="form-input w-full px-4 py-2.5 rounded-xl text-sm">
                        </div>

                        <!-- 發票日期 -->
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5">發票日期 <span class="text-red-400">*</span></label>
                            <input type="date" id="invoiceDate" class="form-input w-full px-4 py-2.5 rounded-xl text-sm">
                        </div>

                        <!-- 發票號碼 -->
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5">發票號碼</label>
                            <input type="text" id="invoiceNumber" class="form-input w-full px-4 py-2.5 rounded-xl text-sm" placeholder="例：AB-12345678">
                        </div>

                        <!-- 備註 -->
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-1.5">備註說明</label>
                            <textarea id="remarks" class="form-input w-full px-4 py-2.5 rounded-xl text-sm resize-none" rows="2" placeholder="選填備註..."></textarea>
                        </div>

                        <!-- 驗證結果預覽 -->
                        <div id="validationPreview" class="validation-panel hidden">
                            <div class="px-4 py-3 border-b border-white/5">
                                <span class="text-xs font-semibold text-slate-300 uppercase tracking-wider">驗證結果預覽</span>
                            </div>
                            <div id="validationItems"></div>
                        </div>

                        <!-- 按鈕 -->
                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="validateForm()" class="btn-primary flex-1 py-2.5 rounded-xl text-sm font-semibold text-white">
                                驗證並提交
                            </button>
                            <button type="button" onclick="resetForm()" class="btn-secondary py-2.5 px-4 rounded-xl text-sm font-medium text-slate-300">
                                清除
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 右側：記錄列表 -->
            <div class="lg:col-span-2 fade-in" style="animation-delay: 0.2s;">
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                            </div>
                            <h2 class="text-base font-semibold text-white">驗證記錄</h2>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="filterRecords('all')" class="filter-btn text-xs px-3 py-1.5 rounded-lg font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-all active" data-filter="all">全部</button>
                            <button onclick="filterRecords('approved')" class="filter-btn text-xs px-3 py-1.5 rounded-lg font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-all" data-filter="approved">通過</button>
                            <button onclick="filterRecords('rejected')" class="filter-btn text-xs px-3 py-1.5 rounded-lg font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-all" data-filter="rejected">未通過</button>
                        </div>
                    </div>

                    <!-- 表格 -->
                    <div class="overflow-x-auto">
                        <table class="data-table w-full text-sm">
                            <thead>
                                <tr class="text-left text-xs text-slate-500 uppercase tracking-wider border-b border-white/5">
                                    <th class="pb-3 pr-4 font-medium">時間</th>
                                    <th class="pb-3 pr-4 font-medium">代碼</th>
                                    <th class="pb-3 pr-4 font-medium">費用項目</th>
                                    <th class="pb-3 pr-4 font-medium">金額</th>
                                    <th class="pb-3 pr-4 font-medium">核銷月 / 發票日</th>
                                    <th class="pb-3 pr-4 font-medium">狀態</th>
                                    <th class="pb-3 font-medium">操作</th>
                                </tr>
                            </thead>
                            <tbody id="recordsBody" class="text-slate-300">
                                <tr>
                                    <td colspan="7" class="py-16 text-center text-slate-500">
                                        <div class="flex flex-col items-center gap-3">
                                            <svg class="w-12 h-12 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                            </svg>
                                            <span class="text-sm">尚無驗證記錄</span>
                                            <span class="text-xs text-slate-600">請從左側表單新增核銷驗證</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 驗證規則說明 -->
                <div class="glass-card rounded-2xl p-6 mt-4">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center">
                            <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h2 class="text-base font-semibold text-white">驗證規則</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flex items-start gap-3 p-3 rounded-xl bg-white/[0.02]">
                            <div class="w-6 h-6 rounded-full bg-indigo-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-indigo-400">1</span>
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-slate-300 mb-1">確認代碼驗證</p>
                                <p class="text-xs text-slate-500">代碼必須為 <code class="px-1.5 py-0.5 rounded bg-white/5 text-indigo-300 font-mono">M842</code> 方可通過</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 rounded-xl bg-white/[0.02]">
                            <div class="w-6 h-6 rounded-full bg-indigo-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-indigo-400">2</span>
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-slate-300 mb-1">費用項目確認</p>
                                <p class="text-xs text-slate-500">費用項目須為 <code class="px-1.5 py-0.5 rounded bg-white/5 text-indigo-300">網路費用</code></p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 rounded-xl bg-white/[0.02]">
                            <div class="w-6 h-6 rounded-full bg-indigo-500/20 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-indigo-400">3</span>
                            </div>
                            <div>
                                <p class="text-xs font-semibold text-slate-300 mb-1">月份一致性</p>
                                <p class="text-xs text-slate-500">核銷月份須與發票日期的月份相同</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 詳細資訊 Modal -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
        <div class="glass-card rounded-2xl p-6 w-full max-w-md relative z-10 mx-4" style="background: rgba(15, 23, 42, 0.95);">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-base font-semibold text-white">驗證詳細資訊</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // ========== 資料儲存 ==========
        let records = JSON.parse(localStorage.getItem('verifyRecords') || '[]');
        let currentFilter = 'all';

        // ========== 常量 ==========
        const VALID_CODE = 'M842';
        const VALID_EXPENSE = '網路費用';

        // ========== 初始化 ==========
        function init() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            renderRecords();
            updateStats();
            setDefaultDates();

            // 即時驗證：代碼輸入
            document.getElementById('confirmCode').addEventListener('input', function() {
                liveValidate();
            });
            // 即時驗證：費用選擇
            document.getElementById('expenseType').addEventListener('change', function() {
                liveValidate();
            });
            // 即時驗證：月份與日期
            document.getElementById('claimMonth').addEventListener('change', liveValidate);
            document.getElementById('invoiceDate').addEventListener('change', liveValidate);
        }

        // ========== 日期時間 ==========
        function updateDateTime() {
            const now = new Date();
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('zh-TW', options);
        }

        function setDefaultDates() {
            const now = new Date();
            const monthStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('claimMonth').value = monthStr;
        }

        // ========== 即時驗證預覽 ==========
        function liveValidate() {
            const code = document.getElementById('confirmCode').value.trim();
            const expense = document.getElementById('expenseType').value;
            const claimMonth = document.getElementById('claimMonth').value;
            const invoiceDate = document.getElementById('invoiceDate').value;

            // 至少要輸入代碼才顯示預覽
            if (!code && !expense && !claimMonth && !invoiceDate) {
                document.getElementById('validationPreview').classList.add('hidden');
                return;
            }

            const checks = getValidationChecks(code, expense, claimMonth, invoiceDate);
            const panel = document.getElementById('validationPreview');
            const items = document.getElementById('validationItems');

            panel.classList.remove('hidden');
            items.innerHTML = checks.map(check => `
                <div class="validation-item">
                    <div class="flex items-center gap-3">
                        <span class="text-xs ${check.pass ? 'text-slate-300' : 'text-slate-400'}">${check.label}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs ${check.pass ? 'text-emerald-400' : check.value ? 'text-red-400' : 'text-slate-600'}">${check.message}</span>
                        ${check.value ? (check.pass
                            ? '<svg class="w-4 h-4 check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>'
                            : '<svg class="w-4 h-4 cross-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>'
                        ) : '<div class="w-4 h-4 rounded-full border border-slate-600"></div>'}
                    </div>
                </div>
            `).join('');

            // 即時反饋：代碼輸入框
            const codeInput = document.getElementById('confirmCode');
            const codeHint = document.getElementById('codeHint');
            if (code) {
                if (code === VALID_CODE) {
                    codeInput.classList.remove('input-error');
                    codeInput.classList.add('input-success');
                    codeHint.textContent = '代碼驗證通過';
                    codeHint.classList.remove('text-red-400');
                    codeHint.classList.add('text-emerald-400');
                } else {
                    codeInput.classList.remove('input-success');
                    codeInput.classList.add('input-error');
                    codeHint.textContent = '代碼不正確';
                    codeHint.classList.remove('text-emerald-400', 'text-slate-500');
                    codeHint.classList.add('text-red-400');
                }
            } else {
                codeInput.classList.remove('input-error', 'input-success');
                codeHint.textContent = '系統將驗證代碼是否正確';
                codeHint.classList.remove('text-red-400', 'text-emerald-400');
                codeHint.classList.add('text-slate-500');
            }
        }

        // ========== 驗證邏輯 ==========
        function getValidationChecks(code, expense, claimMonth, invoiceDate) {
            // 月份比對
            let monthMatch = null;
            let invoiceMonthStr = '';
            if (claimMonth && invoiceDate) {
                const invoiceMonth = invoiceDate.substring(0, 7); // "YYYY-MM"
                invoiceMonthStr = invoiceMonth;
                monthMatch = (claimMonth === invoiceMonth);
            }

            return [
                {
                    label: '確認代碼',
                    value: code,
                    pass: code === VALID_CODE,
                    message: !code ? '尚未輸入' : (code === VALID_CODE ? '驗證通過 (M842)' : `不正確 (${code})`)
                },
                {
                    label: '費用項目',
                    value: expense,
                    pass: expense === VALID_EXPENSE,
                    message: !expense ? '尚未選擇' : (expense === VALID_EXPENSE ? '網路費用 ✓' : `非指定項目 (${expense})`)
                },
                {
                    label: '月份一致性',
                    value: claimMonth && invoiceDate ? true : false,
                    pass: monthMatch === true,
                    message: (!claimMonth || !invoiceDate) ? '尚未填寫完整' : (monthMatch ? '月份一致' : `不一致 (${claimMonth} ≠ ${invoiceMonthStr})`)
                }
            ];
        }

        // ========== 表單驗證與提交 ==========
        function validateForm() {
            const code = document.getElementById('confirmCode').value.trim();
            const expense = document.getElementById('expenseType').value;
            const amount = document.getElementById('amount').value;
            const claimMonth = document.getElementById('claimMonth').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const remarks = document.getElementById('remarks').value.trim();

            // 基本必填驗證
            if (!code || !expense || !amount || !claimMonth || !invoiceDate) {
                showToast('請填寫所有必填欄位', 'error');
                return;
            }

            if (parseFloat(amount) <= 0) {
                showToast('金額必須大於 0', 'error');
                return;
            }

            // 三項驗證
            const checks = getValidationChecks(code, expense, claimMonth, invoiceDate);
            const allPassed = checks.every(c => c.pass);

            // 建立記錄
            const record = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                code,
                expense,
                amount: parseFloat(amount),
                claimMonth,
                invoiceDate,
                invoiceNumber,
                remarks,
                checks,
                status: allPassed ? 'approved' : 'rejected'
            };

            records.unshift(record);
            localStorage.setItem('verifyRecords', JSON.stringify(records));

            renderRecords();
            updateStats();

            if (allPassed) {
                showToast('驗證通過！核銷記錄已建立', 'success');
            } else {
                const failCount = checks.filter(c => !c.pass).length;
                showToast(`驗證未通過，共 ${failCount} 項不符合`, 'error');
            }

            resetForm();
        }

        // ========== 渲染記錄 ==========
        function renderRecords() {
            const tbody = document.getElementById('recordsBody');
            let filtered = records;

            if (currentFilter === 'approved') filtered = records.filter(r => r.status === 'approved');
            else if (currentFilter === 'rejected') filtered = records.filter(r => r.status === 'rejected');

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-16 text-center text-slate-500">
                            <div class="flex flex-col items-center gap-3">
                                <svg class="w-12 h-12 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <span class="text-sm">${currentFilter === 'all' ? '尚無驗證記錄' : '沒有符合篩選條件的記錄'}</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(r => {
                const time = new Date(r.timestamp);
                const timeStr = `${String(time.getMonth() + 1).padStart(2, '0')}/${String(time.getDate()).padStart(2, '0')} ${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}`;
                const statusBadge = r.status === 'approved'
                    ? '<span class="badge badge-approved"><span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>通過</span>'
                    : '<span class="badge badge-rejected"><span class="w-1.5 h-1.5 rounded-full bg-red-400"></span>未通過</span>';

                return `
                    <tr class="border-b border-white/[0.03]">
                        <td class="py-3 pr-4 text-xs text-slate-400">${timeStr}</td>
                        <td class="py-3 pr-4">
                            <code class="text-xs px-2 py-0.5 rounded ${r.code === VALID_CODE ? 'bg-emerald-500/10 text-emerald-300' : 'bg-red-500/10 text-red-300'} font-mono">${r.code}</code>
                        </td>
                        <td class="py-3 pr-4 text-xs">${r.expense}</td>
                        <td class="py-3 pr-4 text-xs font-medium">NT$ ${r.amount.toLocaleString()}</td>
                        <td class="py-3 pr-4 text-xs text-slate-400">${r.claimMonth} / ${r.invoiceDate}</td>
                        <td class="py-3 pr-4">${statusBadge}</td>
                        <td class="py-3">
                            <div class="flex items-center gap-2">
                                <button onclick="viewDetail(${r.id})" class="text-xs text-indigo-400 hover:text-indigo-300 transition-colors">詳情</button>
                                <button onclick="deleteRecord(${r.id})" class="text-xs text-slate-500 hover:text-red-400 transition-colors">刪除</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== 篩選 ==========
        function filterRecords(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
                btn.classList.toggle('text-white', btn.dataset.filter === filter);
                btn.classList.toggle('bg-white/10', btn.dataset.filter === filter);
            });
            renderRecords();
        }

        // ========== 統計 ==========
        function updateStats() {
            const pending = records.filter(r => r.status === 'pending').length;
            const approved = records.filter(r => r.status === 'approved').length;
            const rejected = records.filter(r => r.status === 'rejected').length;
            const total = records.length;

            animateNumber('statPending', pending);
            animateNumber('statApproved', approved);
            animateNumber('statRejected', rejected);
            animateNumber('statTotal', total);
        }

        function animateNumber(id, target) {
            const el = document.getElementById(id);
            const current = parseInt(el.textContent) || 0;
            if (current === target) return;

            const duration = 400;
            const start = performance.now();

            function step(timestamp) {
                const progress = Math.min((timestamp - start) / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.round(current + (target - current) * eased);
                if (progress < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // ========== 詳情 Modal ==========
        function viewDetail(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            const modal = document.getElementById('detailModal');
            const content = document.getElementById('modalContent');

            const statusLabel = record.status === 'approved'
                ? '<span class="badge badge-approved"><span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>驗證通過</span>'
                : '<span class="badge badge-rejected"><span class="w-1.5 h-1.5 rounded-full bg-red-400"></span>驗證未通過</span>';

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-slate-500">驗證狀態</span>
                        ${statusLabel}
                    </div>
                    <div class="validation-panel">
                        ${record.checks.map(c => `
                            <div class="validation-item">
                                <span class="text-xs text-slate-300">${c.label}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs ${c.pass ? 'text-emerald-400' : 'text-red-400'}">${c.message}</span>
                                    ${c.pass
                                        ? '<svg class="w-4 h-4 check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>'
                                        : '<svg class="w-4 h-4 cross-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>'
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="space-y-2 pt-2">
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500">確認代碼</span>
                            <code class="font-mono text-slate-300">${record.code}</code>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500">費用項目</span>
                            <span class="text-slate-300">${record.expense}</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500">核銷金額</span>
                            <span class="text-slate-300 font-medium">NT$ ${record.amount.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500">核銷月份</span>
                            <span class="text-slate-300">${record.claimMonth}</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500">發票日期</span>
                            <span class="text-slate-300">${record.invoiceDate}</span>
                        </div>
                        ${record.invoiceNumber ? `
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500">發票號碼</span>
                            <span class="text-slate-300">${record.invoiceNumber}</span>
                        </div>` : ''}
                        ${record.remarks ? `
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500">備註</span>
                            <span class="text-slate-300">${record.remarks}</span>
                        </div>` : ''}
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-500">驗證時間</span>
                            <span class="text-slate-300">${new Date(record.timestamp).toLocaleString('zh-TW')}</span>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('detailModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // ========== 刪除記錄 ==========
        function deleteRecord(id) {
            records = records.filter(r => r.id !== id);
            localStorage.setItem('verifyRecords', JSON.stringify(records));
            renderRecords();
            updateStats();
            showToast('記錄已刪除', 'info');
        }

        // ========== Toast 訊息 ==========
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const colors = {
                success: 'from-emerald-500/20 to-emerald-500/5 border-emerald-500/20 text-emerald-300',
                error: 'from-red-500/20 to-red-500/5 border-red-500/20 text-red-300',
                info: 'from-blue-500/20 to-blue-500/5 border-blue-500/20 text-blue-300'
            };
            const icons = {
                success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
                error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
            };

            const toast = document.createElement('div');
            toast.className = `toast bg-gradient-to-r ${colors[type]} border rounded-xl px-4 py-3 flex items-center gap-3 backdrop-blur-xl`;
            toast.innerHTML = `
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icons[type]}</svg>
                <span class="text-sm font-medium">${message}</span>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ========== 重設表單 ==========
        function resetForm() {
            document.getElementById('confirmCode').value = '';
            document.getElementById('expenseType').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('invoiceDate').value = '';
            document.getElementById('invoiceNumber').value = '';
            document.getElementById('remarks').value = '';
            document.getElementById('validationPreview').classList.add('hidden');

            const codeInput = document.getElementById('confirmCode');
            const codeHint = document.getElementById('codeHint');
            codeInput.classList.remove('input-error', 'input-success');
            codeHint.textContent = '系統將驗證代碼是否正確';
            codeHint.classList.remove('text-red-400', 'text-emerald-400');
            codeHint.classList.add('text-slate-500');

            setDefaultDates();
        }

        // ========== 鍵盤事件 ==========
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });

        // ========== 啟動 ==========
        init();
    </script>
</body>
</html>
