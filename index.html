<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工報支自動核對與追蹤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: #f8fafc; }

        /* 自訂圓角 */
        .r-32 { border-radius: 32px; }
        .r-40 { border-radius: 40px; }
        .r-48 { border-radius: 48px; }
        .r-24 { border-radius: 24px; }

        /* 輸入框 */
        .field-input {
            width: 100%;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
            font-weight: 800;
            outline: none;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .field-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        .field-input.field-warning {
            border-color: #fbbf24;
            color: #d97706;
        }
        .field-input.field-error {
            border-color: #ef4444;
            color: #dc2626;
        }

        /* 大金額輸入 */
        .amount-input {
            width: 100%;
            background: transparent;
            font-size: 2.25rem;
            font-weight: 900;
            outline: none;
            border: none;
        }
        .amount-input::-webkit-inner-spin-button,
        .amount-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .amount-input { -moz-appearance: textfield; }

        /* 切換按鈕 */
        .toggle-btn {
            padding: 12px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }
        .toggle-btn.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
            transform: scale(1.05);
        }
        .toggle-btn.inactive {
            background: #f1f5f9;
            color: #cbd5e1;
        }

        /* 狀態指示燈 */
        .status-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .status-dot.on {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }
        .status-dot.off {
            background: #1e293b;
            color: #475569;
        }

        /* Toast 動畫 */
        @keyframes slideIn {
            from { transform: translateX(120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-anim { animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Modal 縮放動畫 */
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* 掃描動畫 */
        @keyframes scanning {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        /* 自訂滾動條 */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 2px; }
    </style>
</head>
<body class="min-h-screen p-4 lg:p-8 text-slate-900">

    <!-- Toast 容器 -->
    <div id="toastContainer" class="fixed top-6 right-6 z-50 flex flex-col gap-3"></div>

    <!-- ===== 頂部導航 ===== -->
    <header class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-6 bg-white p-6 r-32 shadow-sm border border-slate-200">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-600 r-24 flex items-center justify-center text-white shadow-lg">
                <!-- Database icon -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-black text-slate-800 tracking-tight">員工報支自動核對與追蹤</h1>
                <div class="flex items-center gap-2 text-slate-400 text-[10px] font-bold uppercase tracking-widest mt-1">
                    <svg class="w-3 h-3 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                    </svg>
                    Local Storage Active
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4 flex-1 max-w-xl">
            <div class="relative flex-1 group">
                <!-- User icon -->
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
                <input
                    type="text"
                    id="employeeName"
                    placeholder="輸入姓名/編號..."
                    class="w-full pl-12 pr-4 py-3 bg-slate-50 border border-slate-100 rounded-2xl font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all shadow-inner"
                />
                <div id="identityBadge" class="absolute right-3 top-1/2 -translate-y-1/2 bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] font-black uppercase hidden">
                    已識別身分
                </div>
            </div>
            <div class="bg-slate-50 p-1 rounded-2xl border border-slate-100 flex items-center shadow-inner">
                <select id="userRole" class="bg-transparent px-4 py-2 font-black text-xs text-blue-600 outline-none cursor-pointer">
                    <option value="manager">主管 (1399)</option>
                    <option value="staff" selected>一般員工 (800)</option>
                    <option value="special">特定專案 (500)</option>
                </select>
            </div>
        </div>
    </header>

    <!-- ===== 主內容 ===== -->
    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- ====== 左側：數據操作區 (8 cols) ====== -->
        <div class="lg:col-span-8 space-y-6">

            <!-- 影像辨識區 -->
            <section class="bg-white r-40 p-8 shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-black flex items-center gap-2 text-slate-700 italic">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/>
                        </svg>
                        影像自動辨識與提取
                    </h2>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <svg class="w-4 h-4 text-slate-300" id="tripIcon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                        <span class="text-xs font-black text-slate-500">公務出差</span>
                        <input type="checkbox" id="isBusinessTrip" class="w-4 h-4 rounded accent-blue-600" />
                    </label>
                </div>

                <!-- 上傳區域 -->
                <div id="uploadArea">
                    <label class="border-4 border-dashed border-slate-50 r-32 h-48 flex flex-col items-center justify-center cursor-pointer hover:border-blue-200 hover:bg-blue-50/20 transition-all group">
                        <input type="file" class="hidden" accept="image/*" id="fileInput" />
                        <svg class="w-8 h-8 text-slate-200 group-hover:text-blue-400 mb-2 transition-colors" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <span class="font-black text-slate-300 text-sm tracking-widest uppercase">Take / Upload Photo</span>
                    </label>
                </div>

                <!-- 預覽區域 (隱藏) -->
                <div id="previewArea" class="hidden relative h-48 r-32 bg-slate-900 overflow-hidden shadow-2xl">
                    <img id="previewImage" src="" alt="preview" class="w-full h-full object-contain opacity-50" />
                    <div id="scanOverlay" class="absolute inset-0 hidden flex-col items-center justify-center bg-blue-900/40 backdrop-blur-md">
                        <svg class="w-8 h-8 animate-spin text-white mb-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                        </svg>
                        <span class="text-white font-black text-xs tracking-widest animate-pulse uppercase italic">Syncing with AI Engine</span>
                    </div>
                    <button onclick="clearPreview()" class="absolute top-4 right-4 bg-white/20 hover:bg-white/40 p-2 rounded-full text-white backdrop-blur-md transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                        </svg>
                    </button>
                </div>
            </section>

            <!-- 雙面板：驗收單 + 發票 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- 驗收單面板 -->
                <div class="bg-white r-40 p-8 shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-6 border-b pb-4 text-blue-600">
                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                        </svg>
                        <h3 class="font-black italic uppercase tracking-tighter">驗收單內容 (Slip)</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase tracking-widest">會計科目</label>
                            <input type="text" id="slipCode" value="M842" class="field-input" />
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase tracking-widest">帳單月份</label>
                            <input type="month" id="slipMonth" class="field-input" />
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase tracking-widest">國際漫遊金額</label>
                        <input type="number" id="roamingAmount" value="0" class="field-input" />
                        <p id="roamingWarning" class="text-[10px] text-red-500 font-black mt-1 italic hidden">! 非公務出差不得申報漫遊費用</p>
                    </div>

                    <div class="mt-6 p-6 bg-blue-50/50 rounded-3xl border border-blue-100/50">
                        <label class="text-[10px] font-black text-blue-400 uppercase mb-1 block">申報金額 (TWD)</label>
                        <input type="number" id="slipAmount" class="amount-input text-blue-700" placeholder="0" />
                        <p id="overLimitWarning" class="text-[10px] text-red-600 font-black mt-2 hidden"></p>
                    </div>
                </div>

                <!-- 發票面板 -->
                <div class="bg-white r-40 p-8 shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 mb-6 border-b pb-4 text-indigo-600">
                        <svg class="w-[18px] h-[18px]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
                        </svg>
                        <h3 class="font-black italic uppercase tracking-tighter">發票憑證 (Invoice)</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase tracking-widest">憑證日期</label>
                            <input type="date" id="invoiceDate" class="field-input" />
                        </div>
                        <div id="invoiceMonthBox" class="p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-slate-50 text-slate-300 border-slate-100">
                            月份: --
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button id="btnPaid" onclick="togglePaid()" class="toggle-btn inactive">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            </svg>
                            已繳費
                        </button>
                        <button id="btnStamp" onclick="toggleStamp()" class="toggle-btn inactive">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
                            </svg>
                            有起訖章
                        </button>
                    </div>

                    <div class="mt-4 p-6 bg-slate-50 rounded-3xl border border-slate-100">
                        <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">憑證記載總額</label>
                        <input type="number" id="invoiceAmount" class="amount-input text-slate-700" placeholder="0" />
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== 右側：狀態檢查 + 歷史 (4 cols) ====== -->
        <div class="lg:col-span-4 space-y-6">

            <!-- Compliance Check -->
            <section class="bg-slate-900 text-white r-40 p-8 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-bl-full"></div>

                <h2 class="text-lg font-black mb-8 flex items-center gap-2 relative z-10 italic underline decoration-blue-500 underline-offset-8">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0 1 12 2.944a11.955 11.955 0 0 1-8.618 3.04A12.02 12.02 0 0 0 3 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    Compliance Check
                </h2>

                <div class="space-y-6 relative z-10" id="statusChecks">
                    <!-- 動態生成 -->
                </div>

                <button
                    id="submitBtn"
                    onclick="handleSave()"
                    disabled
                    class="w-full mt-12 py-5 r-24 font-black text-xl transition-all transform active:scale-95 shadow-2xl bg-slate-800 text-slate-600 cursor-not-allowed shadow-none"
                >
                    資訊未齊全
                </button>
            </section>

            <!-- 個人申請歷史 -->
            <section class="bg-white r-32 p-6 shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-4 border-b pb-4">
                    <h3 class="text-sm font-black text-slate-800 flex items-center gap-2 uppercase tracking-tighter">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        個人申請歷史
                    </h3>
                    <svg class="w-4 h-4 text-slate-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>
                    </svg>
                </div>
                <div id="historyList" class="space-y-3 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                    <div class="py-8 text-center text-slate-300 font-bold text-xs uppercase tracking-widest italic">Enter name to track history</div>
                </div>
            </section>
        </div>
    </main>

    <!-- ===== 成功 Modal ===== -->
    <div id="successModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-xl hidden items-center justify-center p-4 z-50">
        <div class="bg-white r-48 p-12 max-w-sm w-full text-center shadow-2xl scale-in">
            <div class="w-24 h-24 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner">
                <svg class="w-14 h-14" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
            </div>
            <h3 class="text-3xl font-black text-slate-900 mb-2 tracking-tighter uppercase italic">Verified</h3>
            <p class="text-slate-400 font-bold text-[10px] mb-8 tracking-[0.5em] uppercase">Record Saved Successfully</p>
            <div id="modalSummary" class="bg-slate-50 rounded-3xl p-6 text-left mb-10 space-y-3 font-bold text-xs">
            </div>
            <button onclick="closeSuccessModal()" class="w-full py-5 bg-slate-900 text-white rounded-3xl font-black text-lg hover:bg-blue-600 transition-all shadow-xl">
                處理下一筆
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="max-w-7xl mx-auto mt-12 py-8 text-center text-slate-300 font-black text-[10px] tracking-[0.8em] uppercase opacity-40">
        AI Intelligent Auditor &bull; Persistence
    </footer>

    <script>
    // ============================================================
    // 狀態管理
    // ============================================================
    let records = JSON.parse(localStorage.getItem('expenseRecords') || '[]');
    let profiles = JSON.parse(localStorage.getItem('employeeProfiles') || '{}');
    let isPaid = false;
    let hasStamp = false;

    // 角色額度上限
    const roleLimits = { manager: 1399, staff: 800, special: 500 };

    // ============================================================
    // DOM 快取
    // ============================================================
    const $ = id => document.getElementById(id);

    // ============================================================
    // 初始化
    // ============================================================
    function init() {
        // 設定預設月份
        const now = new Date();
        $('slipMonth').value = now.toISOString().slice(0, 7);

        // 綁定所有即時驗證事件
        const liveFields = ['employeeName', 'slipCode', 'slipMonth', 'slipAmount', 'invoiceDate', 'invoiceAmount', 'roamingAmount'];
        liveFields.forEach(id => {
            $(id).addEventListener('input', runValidation);
            $(id).addEventListener('change', runValidation);
        });

        $('userRole').addEventListener('change', () => {
            runValidation();
        });

        $('isBusinessTrip').addEventListener('change', () => {
            const icon = $('tripIcon');
            if ($('isBusinessTrip').checked) {
                icon.classList.remove('text-slate-300');
                icon.classList.add('text-blue-500');
            } else {
                icon.classList.remove('text-blue-500');
                icon.classList.add('text-slate-300');
            }
            runValidation();
        });

        // 姓名改變 -> 載入身分
        $('employeeName').addEventListener('input', () => {
            const name = $('employeeName').value.trim();
            if (name && profiles[name]) {
                $('userRole').value = profiles[name].role;
                $('identityBadge').classList.remove('hidden');
            } else {
                $('identityBadge').classList.add('hidden');
            }
            renderHistory();
        });

        // 發票日期改變 -> 顯示月份
        $('invoiceDate').addEventListener('change', () => {
            const val = $('invoiceDate').value;
            const box = $('invoiceMonthBox');
            if (val) {
                const m = val.slice(0, 7);
                const slipM = $('slipMonth').value;
                if (slipM && slipM === m) {
                    box.className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-green-50 text-green-600 border-green-100';
                } else {
                    box.className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-red-50 text-red-500 border-red-100';
                }
                box.textContent = '月份: ' + m;
            } else {
                box.className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-slate-50 text-slate-300 border-slate-100';
                box.textContent = '月份: --';
            }
        });

        // 圖片上傳
        $('fileInput').addEventListener('change', handleFileUpload);

        // 初始驗證
        runValidation();
        renderHistory();
    }

    // ============================================================
    // 核心驗證邏輯
    // ============================================================
    function runValidation() {
        const name = $('employeeName').value.trim();
        const code = $('slipCode').value.trim().toUpperCase();
        const slipMonth = $('slipMonth').value;
        const slipAmt = parseFloat($('slipAmount').value) || 0;
        const invDate = $('invoiceDate').value;
        const invAmt = parseFloat($('invoiceAmount').value) || 0;
        const roaming = parseFloat($('roamingAmount').value) || 0;
        const role = $('userRole').value;
        const limit = roleLimits[role];
        const trip = $('isBusinessTrip').checked;

        const invMonth = invDate ? invDate.slice(0, 7) : null;

        // 計算各驗證項
        const isNameOK = !!name;
        const isAmountMatch = slipAmt > 0 && slipAmt === invAmt;
        const isCodeMatch = code === 'M842';
        const isMonthMatch = slipMonth && invMonth && slipMonth === invMonth;
        const isUnderLimit = slipAmt <= limit;
        const isRoamingOK = roaming > 0 ? trip : true;
        const isDocReady = isPaid;

        const amountDiff = Math.abs(slipAmt - invAmt);

        // 代碼欄位警告
        const codeInput = $('slipCode');
        if (code && !isCodeMatch) {
            codeInput.classList.add('field-warning');
        } else {
            codeInput.classList.remove('field-warning');
        }

        // 金額超限警告
        const amtInput = $('slipAmount');
        const overWarn = $('overLimitWarning');
        if (slipAmt > limit) {
            amtInput.classList.add('text-red-600');
            amtInput.classList.remove('text-blue-700');
            overWarn.textContent = `▲ 已超過身分額度上限 ($${limit})`;
            overWarn.classList.remove('hidden');
        } else {
            amtInput.classList.remove('text-red-600');
            amtInput.classList.add('text-blue-700');
            overWarn.classList.add('hidden');
        }

        // 漫遊警告
        const roamWarn = $('roamingWarning');
        const roamInput = $('roamingAmount');
        if (roaming > 0 && !trip) {
            roamWarn.classList.remove('hidden');
            roamInput.classList.add('field-warning');
        } else {
            roamWarn.classList.add('hidden');
            roamInput.classList.remove('field-warning');
        }

        // 發票月份顯示
        const box = $('invoiceMonthBox');
        if (invDate) {
            if (isMonthMatch) {
                box.className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-green-50 text-green-600 border-green-100';
            } else {
                box.className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-red-50 text-red-500 border-red-100';
            }
            box.textContent = '月份: ' + invMonth;
        }

        // 渲染右側狀態面板
        const checks = [
            { active: isNameOK, label: '已確認姓名', detail: name || 'MISSING' },
            { active: isAmountMatch, label: '金額核對', detail: isAmountMatch ? 'MATCH' : `DIFF $${amountDiff}` },
            { active: isMonthMatch, label: '月份一致', detail: isMonthMatch ? 'OK' : 'ERROR' },
            { type: 'hr' },
            { active: isUnderLimit, label: '額度合規', detail: `UPTO ${limit}` },
            { active: isRoamingOK, label: '漫遊許可', detail: roaming > 0 ? (trip ? '出差中' : '非核准') : '不適用' },
            { active: isDocReady, label: '費用繳訖', detail: isPaid ? '已確認' : '待補' },
        ];

        const container = $('statusChecks');
        container.innerHTML = checks.map(c => {
            if (c.type === 'hr') return '<hr class="border-slate-800" />';
            return `
                <div class="flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                        <div class="status-dot ${c.active ? 'on' : 'off'}">
                            ${c.active
                                ? '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
                                : '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
                            }
                        </div>
                        <span class="font-black text-xs uppercase tracking-tighter ${c.active ? 'text-white' : 'text-slate-600'}">${c.label}</span>
                    </div>
                    <span class="text-[9px] font-black italic tracking-widest transition-all ${c.active ? 'text-blue-400 underline underline-offset-4' : 'text-slate-800'}">${c.detail}</span>
                </div>
            `;
        }).join('');

        // 提交按鈕狀態
        const canSubmit = isNameOK && isAmountMatch && isCodeMatch && isMonthMatch && isUnderLimit && isRoamingOK && isDocReady;
        const btn = $('submitBtn');
        if (canSubmit) {
            btn.disabled = false;
            btn.className = 'w-full mt-12 py-5 r-24 font-black text-xl transition-all transform active:scale-95 shadow-2xl bg-blue-600 text-white hover:bg-blue-500 cursor-pointer shadow-blue-500/30';
            btn.textContent = '核對無誤 • 儲存進度';
        } else {
            btn.disabled = true;
            btn.className = 'w-full mt-12 py-5 r-24 font-black text-xl transition-all transform active:scale-95 shadow-2xl bg-slate-800 text-slate-600 cursor-not-allowed shadow-none';
            btn.textContent = '資訊未齊全';
        }
    }

    // ============================================================
    // 切換按鈕
    // ============================================================
    function togglePaid() {
        isPaid = !isPaid;
        const btn = $('btnPaid');
        btn.className = isPaid ? 'toggle-btn active' : 'toggle-btn inactive';
        runValidation();
    }

    function toggleStamp() {
        hasStamp = !hasStamp;
        const btn = $('btnStamp');
        btn.className = hasStamp ? 'toggle-btn active' : 'toggle-btn inactive';
    }

    // ============================================================
    // 儲存
    // ============================================================
    function handleSave() {
        const name = $('employeeName').value.trim();
        const role = $('userRole').value;
        const code = $('slipCode').value.trim();
        const month = $('slipMonth').value;
        const amount = $('slipAmount').value;
        const roaming = $('roamingAmount').value;
        const invDate = $('invoiceDate').value;
        const invAmt = $('invoiceAmount').value;

        const recordId = `${name}_${month}_${Date.now()}`;

        // 儲存員工檔案
        profiles[name] = { name, role, lastActive: new Date().toISOString() };
        localStorage.setItem('employeeProfiles', JSON.stringify(profiles));

        // 儲存紀錄
        const record = {
            id: recordId,
            employeeName: name,
            userRole: role,
            slipData: { code, month, amount, roamingAmount: roaming },
            invoiceData: { date: invDate, amount: invAmt },
            isBusinessTrip: $('isBusinessTrip').checked,
            isPaid,
            hasStamp,
            createdAt: new Date().toISOString(),
            month
        };

        records.unshift(record);
        localStorage.setItem('expenseRecords', JSON.stringify(records));

        // 顯示成功
        const summary = $('modalSummary');
        const roleLabel = { manager: '主管', staff: '一般員工', special: '特定專案' };
        summary.innerHTML = `
            <p class="flex justify-between"><span>申請人：</span><span class="text-slate-900 font-black italic underline decoration-blue-500">${name}</span></p>
            <p class="flex justify-between"><span>身分：</span><span class="text-slate-500">${roleLabel[role]}</span></p>
            <p class="flex justify-between"><span>金額：</span><span class="text-blue-600 font-black">$ ${parseFloat(amount).toLocaleString()}</span></p>
            <p class="flex justify-between"><span>月份：</span><span class="text-slate-500">${month}</span></p>
            ${parseFloat(roaming) > 0 ? `<p class="flex justify-between"><span>漫遊：</span><span class="text-amber-500 font-black">$ ${parseFloat(roaming).toLocaleString()}</span></p>` : ''}
        `;

        $('successModal').classList.remove('hidden');
        $('successModal').classList.add('flex');

        renderHistory();
        showToast('驗證通過！紀錄已儲存', 'success');
    }

    function closeSuccessModal() {
        $('successModal').classList.add('hidden');
        $('successModal').classList.remove('flex');
        clearPreview();

        // 部分重設（保留姓名與角色）
        $('slipAmount').value = '';
        $('invoiceAmount').value = '';
        $('invoiceDate').value = '';
        $('roamingAmount').value = '0';
        isPaid = false;
        hasStamp = false;
        $('btnPaid').className = 'toggle-btn inactive';
        $('btnStamp').className = 'toggle-btn inactive';
        $('invoiceMonthBox').className = 'p-3 rounded-xl border flex items-center justify-center font-black text-xs bg-slate-50 text-slate-300 border-slate-100';
        $('invoiceMonthBox').textContent = '月份: --';
        runValidation();
    }

    // ============================================================
    // 歷史紀錄
    // ============================================================
    function renderHistory() {
        const name = $('employeeName').value.trim();
        const list = $('historyList');

        if (!name) {
            list.innerHTML = '<div class="py-8 text-center text-slate-300 font-bold text-xs uppercase tracking-widest italic">Enter name to track history</div>';
            return;
        }

        const history = records
            .filter(r => r.employeeName === name)
            .sort((a, b) => b.month.localeCompare(a.month));

        if (history.length === 0) {
            list.innerHTML = '<div class="py-10 text-center text-slate-300 font-bold italic text-xs uppercase">No history records</div>';
            return;
        }

        list.innerHTML = history.map(r => {
            const roam = parseFloat(r.slipData.roamingAmount) || 0;
            return `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-2xl hover:bg-blue-50 transition-colors group">
                    <div>
                        <p class="text-[10px] font-black text-slate-900 italic tracking-tighter">${r.month}</p>
                        <p class="text-[9px] font-bold text-slate-400">${r.slipData.code}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-blue-600">$${parseFloat(r.slipData.amount).toLocaleString()}</p>
                        <p class="text-[8px] font-black uppercase ${roam > 0 ? 'text-amber-500' : 'text-slate-300'}">
                            ${roam > 0 ? 'Roaming Incl.' : 'Std Fee'}
                        </p>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ============================================================
    // 圖片上傳（模擬 OCR）
    // ============================================================
    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onloadend = () => {
            $('uploadArea').classList.add('hidden');
            $('previewArea').classList.remove('hidden');
            $('previewImage').src = reader.result;

            // 模擬掃描動畫
            $('scanOverlay').classList.remove('hidden');
            $('scanOverlay').classList.add('flex');

            setTimeout(() => {
                $('scanOverlay').classList.add('hidden');
                $('scanOverlay').classList.remove('flex');
                showToast('圖片已載入（OCR 需配置 API Key）', 'info');
            }, 2000);
        };
        reader.readAsDataURL(file);
    }

    function clearPreview() {
        $('previewArea').classList.add('hidden');
        $('uploadArea').classList.remove('hidden');
        $('previewImage').src = '';
        $('fileInput').value = '';
    }

    // ============================================================
    // Toast
    // ============================================================
    function showToast(message, type = 'info') {
        const container = $('toastContainer');
        const colors = {
            success: 'bg-green-50 border-green-200 text-green-700',
            error: 'bg-red-50 border-red-200 text-red-700',
            info: 'bg-blue-50 border-blue-200 text-blue-700'
        };
        const icons = {
            success: '<polyline points="22 4 12 14.01 9 11.01"/>',
            error: '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>',
            info: '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
        };

        const toast = document.createElement('div');
        toast.className = `toast-anim ${colors[type]} border rounded-2xl px-5 py-3 flex items-center gap-3 shadow-lg font-bold text-sm`;
        toast.innerHTML = `
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">${icons[type]}</svg>
            ${message}
        `;
        container.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            toast.style.transition = 'all 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ============================================================
    // 啟動
    // ============================================================
    init();
    </script>
</body>
</html>
